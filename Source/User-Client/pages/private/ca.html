<!doctype html>
<html>
    <head>
        <title></title>
        <meta charset="utf-8" />
    </head>
    <body>
        <h2>Look at the console for demo</h2>
        
        <!-- <script src="/file/demo-bundle.js"></script> -->
	<script src="/script/web3.js-1.3.4/dist/web3.min.js"></script>
        <script src="/script/sector-abi.js"></script>
	<script src="/script/rsablind-bundle.js"></script>
        <script>
	 var contractAddress = null, ca_keystore = null, patron_pubkey_components = null, patron_ethr_address = null;
	 var prepare_for_transaction = () => {
	     patron1_rsa_publickey = "-----BEGIN RSA PUBLIC KEY-----\n"+
					 "MIIBCgKCAQEAiWiTeJ9UYocPVMAWg84+VEVWX41n32n/+I54AJpAQKPaRPAuDPLS\n"+
					 "Y6H/3rFl8CS3hEfPUYht8ROi96nBWFZg+N9m0ODAcqZUU7psV4PjAJzsN0tFi2e/\n"+
					 "ndI3YmfJyBPkkv15MjD6zEb5dC1iG3wiPlBvq6J+izROCRCr8Zp6NT3rqN0SOY6r\n"+
					 "7HOmuy5AEOnfVsUpYXadobzmZ0/CP5wGIZOGRfWflfITrjJ7i8MTGIxL8t0Qzoma\n"+
					 "A7n/fCZh1TCXHSchcUmPZKsY4eDGDUNwJ6mu5sXfAxAHq+UD+a2X8w2SdJ/3YgYN\n"+
					 "OmjpI7tz7Q1dyAQJJ8RIqYW6XxaVo3REZwIDAQAB\n"+
					 "-----END RSA PUBLIC KEY-----";
	     patron1_pubkey = new window.myexports.NodeRSA(patron1_rsa_publickey, "pkcs1-public");
	     ca_keystore = {"address":"7b5fb9a5535f2976cdc99c57d19111b2ed3cb925",
				"crypto":{"cipher":"aes-128-ctr",
					  "ciphertext":"da0a2895031a9a773277fdf42e8534a9e6c55c580c8b71a714aa27a908d538ec",
					  "cipherparams":{"iv":"a15a517abd181dc28b6790896d7d1796"},
					  "kdf":"scrypt",
					  "kdfparams":{"dklen":32,
						       "n":262144,
						       "p":1,
						       "r":8,
						       "salt":"44074d0e02e9e40e53d791bfecc452a603dece2a7eb84f21202d29888d3cc96d"},
					  "mac":"e8c0e97cdbedcd59d5d7adeaca0c688622970bc3b8e29d8cc0f38915bbe7eafd"},
				"id":"b40ac0fb-3b9c-4c92-97c1-400cefc289dc",
				"version":3};
	     contractAddress = "0x760661c2376aa98cB4CA42Bc85e2e2136A5E7B9A";

	     console.log("Preparing patron public-key components");
	     patron_pubkey_components = {n:"0x".concat( patron1_pubkey.keyPair.n.toString(16) ),
					 e:"0x".concat( patron1_pubkey.keyPair.e.toString(16) )};
	     
	     patron_ethr_address = "0x394d8968bfe3427a7e7c2f02db31dd1022951306";
	 }; 

	 var execute_createPatron = (test=true) => {
	     console.log("Establishing Connection to Blockchain Provider");
             let web3 = new Web3("http://141.5.102.54:8545");
	     console.log("Initializing Smart Contract object");
	     contract = new web3.eth.Contract(abi, contractAddress);
	     console.log("Decrypting CA's Account");
	     ca_account = web3.eth.accounts.decrypt(ca_keystore, "test");
	     console.log("Adding account to web3 wallet");
	     web3.eth.accounts.wallet.add(ca_account);
	     createPatron = contract.methods.createPatron(patron_ethr_address,
							  patron_pubkey_components.e,
							  patron_pubkey_components.n);
	     console.log("Testing createPatron()");
	     options = {gas:1000000,
			from:ca_account.address};
	     createPatron.call(options=options,
			       callback = (errors, result) => {
		 if (! errors){
		     console.log("createPatron has no obvious errors");
		 }
		 else{
		     console.log("Errors occurred");
		     throw errors;
		 }
		 if (test){
		     console.log("Test completed without sending transaction");
		     return
		 }
		 console.log(`Attempting to send transcation to smart contract from account "${ca_account.address}"`);
		 createPatron.send(options=options,
				   callback=(errors, result) => {
				       if (errors){
					   throw errors;
				       }
				       console.log("SUCCESS!! Transaction sent to smart contract with result:");
				       console.log(result);
		 });
	     });
	 }
        </script>
        
    </body>
</html>
