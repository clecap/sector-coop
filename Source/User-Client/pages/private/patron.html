<!doctype html>
<html>
    <head>
	<title></title>
	<meta charset="utf-8" />
    </head>
    <body>
	<h1>Patron. Check console</h1>
	<script src="/script/rsablind-bundle.js"></script>
	<script src="/script/socket.io-client-3.1.1/dist/socket.io.min.js"></script>
	<script>
	 var BlindSignature = window.myexports.BlindSignature;
	 var patron1_keystore = { "address": "394d8968bfe3427a7e7c2f02db31dd1022951306",
				  "crypto": { "cipher": "aes-128-ctr",
					      "ciphertext": "ad8417807f2b4a97f711c9bf8dd44e0164ab02fc4169694994fdce4a45fc01fb",
					      "cipherparams": { "iv": "9f11cd8e8926186f685b77240a6c3a75" },
					      "kdf": "scrypt",
					      "kdfparams": { "dklen": 32,
							     "n": 262144,
							     "p": 1,
							     "r": 8,
							     "salt": "a32396e0d6e89cbf25c11b2b66407b7f39650b5f5579e9c36c77963e016f9d0b" },
					      "mac": "d9534e3edce850347da8a4df438ed786e6c35359627bb728056b738d75016f1e" },
				  "id": "8a0cc03b-1a70-4f04-afa8-b73c7c51ed08",
				  "version": 3 };
	 if (!confirm("Wait for Signing Request?")){
	     throw new Error("Cannot proceed without user's go.");
	 }
	 console.log("Generating 2048 Bit RSA key");
	 var patron1_RSAPrivateKey = "-----BEGIN RSA PRIVATE KEY-----\n"+
				     "MIIEpAIBAAKCAQEAiWiTeJ9UYocPVMAWg84+VEVWX41n32n/+I54AJpAQKPaRPAu\n"+
				     "DPLSY6H/3rFl8CS3hEfPUYht8ROi96nBWFZg+N9m0ODAcqZUU7psV4PjAJzsN0tF\n"+
				     "i2e/ndI3YmfJyBPkkv15MjD6zEb5dC1iG3wiPlBvq6J+izROCRCr8Zp6NT3rqN0S\n"+
				     "OY6r7HOmuy5AEOnfVsUpYXadobzmZ0/CP5wGIZOGRfWflfITrjJ7i8MTGIxL8t0Q\n"+
				     "zomaA7n/fCZh1TCXHSchcUmPZKsY4eDGDUNwJ6mu5sXfAxAHq+UD+a2X8w2SdJ/3\n"+
				     "YgYNOmjpI7tz7Q1dyAQJJ8RIqYW6XxaVo3REZwIDAQABAoIBAH6nFJ7vBUHXyYrN\n"+
				     "jzMoTA0y5/0lAqRMOPLqprOveh/ap5o5Y8jtnHzXWlfyXcpunXThF7fIL8Yw2lq7\n"+
				     "boo0/CcJC+Tl9Jz4sOuH/srftsHe4l/JEq3/EACxPfmHPtcbdukBl89qlBDsLowm\n"+
				     "NLKuxYV4cKXcHhXDPVZftoz4XUJqmOrZhe1tbG9wAaQt0ljgYp2l8iCVlUmuGG+c\n"+
				     "LjOVlb/X5cl8oWVfqbVP2PH7eoRsxXmYq/hRPI6kbz3CZNCx4df29Rv+roPLQeQN\n"+
				     "r6iTU5Bi5mOkF4ftRqjQIsBt9Yq4U/+krzm7OoNNz5lKFpIJYybFvWeLYXLlLMar\n"+
				     "0TwdTCECgYEAykR6jYRY0fCXRdgODPrHvRg487qEG5sAf5DI6pg6dDT8pzbm9Gij\n"+
				     "NqfrI/zbeM4v2y8wEXuAHgp9iYiR3anXjjlKGMbKpWj1+sB0x2QKMG2GkXLal2KY\n"+
				     "uFWNIpTbWZ4x2bdW8NUibkXDNw9uMAuYtITxh01u0E0h9zQxS00xVTcCgYEArelC\n"+
				     "OfSVLPRUBNJlkV1PcYo2nxs1Fg9ZmkQyfdyeaH4R9Gy+Q1s+HEv5IDqJ5EbHYWz/\n"+
				     "OkCvnHqbb+/i33vAOczyEhDfP4t4rYYCuvWLXL25hzqez18dKaLpH8/PC0HnEm02\n"+
				     "C2R8tMzEXajWhgNMxv6b8krJuHZmP0eo/3YxIlECgYEArmUgrYfg9RJVu5ivdK19\n"+
				     "LiMGZ873PL4GTfbN5MdgDvXoqVwDAdR+dQ+PBDZuHNjaFke3UDuFmWE+ICkqa06X\n"+
				     "Vj87DeXIr5myDIOHrKsqxdqJXjsDEeem+bh5uclS3xAwtyEGyxtZVm68BGs/fBlj\n"+
				     "jrHZdeljlCINGRFdNynVUT0CgYByu4R5f6Y6tiYH2FYxhIG4whou9WAcYZwXbg5x\n"+
				     "gm7vONzXiDYtcbCUMnr0jCoUc61t1N68q5gvf6O0QWpHTfkPKOo6iO7/mR/QOqzq\n"+
				     "cruyP2h6km3bGUDACz4JQquxHZU4Ttxsv6qWDNEviQed+edZEPgI7NYP3+ysqrYP\n"+
				     "cwYPQQKBgQCaBMS21TXuuaJ8pQQraoX19aT2W8kyZuxPk5zy/r5bZ/m+6HFyS7Ap\n"+
				     "Te+wY+1stKMPw4sL1KulJTw0m1rugqtWqfxC5liUmlB0gHpFGEmYmYYsZ0kTU4YX\n"+
				     "FS9k3DesGV2gcMAsOAda2iM9bFn014TFc8M8uNLmNbJZaMxDtIDDrQ==\n"+
				     "-----END RSA PRIVATE KEY-----";
	 const Bob = {
	     key: new window.myexports.NodeRSA(patron1_RSAPrivateKey, "pkcs1-private"),
	     blinded: null,
	     unblinded: null,
	     message: null,
	 };
	 
	 console.log("Generation completed. Establishing socket with server, waiting for psuedonym");
	 
	 const socket = io({auth: {role:"patron",
				   token:"uniquePatronToken",
				   roomCode:"patronRoom",
				   publicKey:{n : Bob.key.keyPair.n.toString(16),
					      e : Bob.key.keyPair.e.toString(16)}}});

	 socket.on('psuedonymSigningRequest', (blindedHash) => {
	     console.log("Recieved Signing Request from Psuedonym");
	     Bob.blinded = blindedHash;
	     const signed = BlindSignature.signHEX({
		 blinded: Bob.blinded,
		 key: Bob.key
	     });
	     console.log('Sending blindSignature');
	    
	     socket.emit('signingResponse', signed.toString(16));
	 });
	 
	</script>
    </body>
</html>
